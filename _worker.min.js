import{connect}from"cloudflare:sockets";const e=["cdn.appsflyer.com"];let t="d342d11e-d424-4583-b36e-524ab1f0afa4";const n=["cdn.xn--b6gac.eu.org","cdn-all.xn--b6gac.eu.org","workers.cloudflare.cyou"];let r=n[Math.floor(Math.random()*n.length)],a="https://freedns.controld.com/p0";if(!u(t))throw new Error("uuid is invalid");export default{async fetch(n,s,i){try{t=s.UUID||t,r=s.proxyIP||r,a=s.DNS_RESOLVER_URL||a;let i=t;t.includes(",")&&(i=t.split(",")[0]);const c=n.headers.get("Upgrade");if(c&&"websocket"===c)return await o(n);{const r=new URL(n.url);switch(r.pathname){case"/cf":return new Response(JSON.stringify(n.cf,null,4),{status:200,headers:{"Content-Type":"application/json;charset=utf-8"}});case`/${i}`:{const e=v(t,n.headers.get("Host"));return new Response(`${e}`,{status:200,headers:{"Content-Type":"text/html; charset=utf-8"}})}case`/sub/${i}`:{new URL(n.url).searchParams;const e=x(t,n.headers.get("Host"));return new Response(btoa(e),{status:200,headers:{"Content-Type":"text/plain;charset=utf-8"}})}case`/bestip/${i}`:{const e=n.headers,r=`https://sub.xf.free.hr/auto?host=${n.headers.get("Host")}&uuid=${t}&path=/`;return await fetch(r,{headers:e})}default:const a=e[Math.floor(Math.random()*e.length)],o=new Headers(n.headers);o.set("cf-connecting-ip","1.2.3.4"),o.set("x-forwarded-for","1.2.3.4"),o.set("x-real-ip","1.2.3.4"),o.set("referer","https://www.google.com/search?q=edtunnel");const s="https://"+a+r.pathname+r.search;let c=new Request(s,{method:n.method,headers:o,body:n.body,redirect:"manual"});const l=await fetch(c,{redirect:"manual"});return[301,302].includes(l.status)?new Response(`Redirects to ${a} are not allowed.`,{status:403,statusText:"Forbidden"}):l}}}catch(e){return new Response(e.toString())}}};async function o(e){const n=new WebSocketPair,[r,a]=Object.values(n);a.accept();let o="",l="",d=new Date;const u=(e,t)=>{console.log(`[${d} ${o}:${l}] ${e}`,t||"")},p=e.headers.get("sec-websocket-protocol")||"",f=i(a,p,u);let h={value:null},m=null,b=!1;return f.pipeTo(new WritableStream({async write(e,n){if(b&&m)return m(e);if(h.value){const t=h.value.writable.getWriter();return await t.write(e),void t.releaseLock()}const{hasError:r,message:i,portRemote:d=443,addressRemote:p="",rawDataIndex:f,vlessVersion:w=new Uint8Array([0,0]),isUDP:y}=c(e,t);if(o=p,l=`${d} ${y?"udp":"tcp"} `,r)throw new Error(i);if(y&&53!==d)throw new Error("UDP proxy only enabled for DNS which is port 53");y&&53===d&&(b=!0);const $=new Uint8Array([w[0],0]),k=e.slice(f);if(b){const{write:e}=await g(a,$,u);return m=e,void m(k)}s(h,p,d,k,a,$,u)},close(){u("readableWebSocketStream is close")},abort(e){u("readableWebSocketStream is abort",JSON.stringify(e))}})).catch((e=>{u("readableWebSocketStream pipeTo error",e)})),new Response(null,{status:101,webSocket:r})}async function s(e,t,n,a,o,s,i){async function c(t,n){const r=connect({hostname:t,port:n});e.value=r,i(`connected to ${t}:${n}`);const o=r.writable.getWriter();return await o.write(a),o.releaseLock(),r}l(await c(t,n),o,s,(async function(){const e=await c(r||t,n);e.closed.catch((e=>{console.log("retry tcpSocket closed error",e)})).finally((()=>{h(o)})),l(e,o,s,null,i)}),i)}function i(e,t,n){let r=!1;return new ReadableStream({start(r){e.addEventListener("message",(e=>{const t=e.data;r.enqueue(t)})),e.addEventListener("close",(()=>{h(e),r.close()})),e.addEventListener("error",(e=>{n("webSocketServer has error"),r.error(e)}));const{earlyData:a,error:o}=d(t);o?r.error(o):a&&r.enqueue(a)},pull(e){},cancel(t){n(`ReadableStream was canceled, due to ${t}`),r=!0,h(e)}})}function c(e,t){if(e.byteLength<24)return{hasError:!0,message:"invalid data"};const n=new Uint8Array(e.slice(0,1));let r=!1,a=!1;const o=w(new Uint8Array(e.slice(1,17))),s=t.includes(",")?t.split(","):[t];if(r=s.some((e=>o===e.trim()))||1===s.length&&o===s[0].trim(),console.log(`userID: ${o}`),!r)return{hasError:!0,message:"invalid user"};const i=new Uint8Array(e.slice(17,18))[0],c=new Uint8Array(e.slice(18+i,18+i+1))[0];if(1===c)a=!1;else{if(2!==c)return{hasError:!0,message:`command ${c} is not support, command 01-tcp,02-udp,03-mux`};a=!0}const l=18+i+1,d=e.slice(l,l+2),u=new DataView(d).getUint16(0);let p=l+2;const f=new Uint8Array(e.slice(p,p+1))[0];let h=0,m=p+1,b="";switch(f){case 1:h=4,b=new Uint8Array(e.slice(m,m+h)).join(".");break;case 2:h=new Uint8Array(e.slice(m,m+1))[0],m+=1,b=(new TextDecoder).decode(e.slice(m,m+h));break;case 3:h=16;const t=new DataView(e.slice(m,m+h)),n=[];for(let e=0;e<8;e++)n.push(t.getUint16(2*e).toString(16));b=n.join(":");break;default:return{hasError:!0,message:`invild  addressType is ${f}`}}return b?{hasError:!1,addressRemote:b,addressType:f,portRemote:u,rawDataIndex:m+h,vlessVersion:n,isUDP:a}:{hasError:!0,message:`addressValue is empty, addressType is ${f}`}}async function l(e,t,n,r,a){let o=n,s=!1;await e.readable.pipeTo(new WritableStream({start(){},async write(e,n){s=!0,t.readyState!==p&&n.error("webSocket.readyState is not open, maybe close"),o?(t.send(await new Blob([o,e]).arrayBuffer()),o=null):t.send(e)},close(){a(`remoteConnection!.readable is close with hasIncomingData is ${s}`)},abort(e){console.error("remoteConnection!.readable abort",e)}})).catch((e=>{console.error("remoteSocketToWS has exception ",e.stack||e),h(t)})),!1===s&&r&&(a("retry"),r())}function d(e){if(!e)return{earlyData:null,error:null};try{e=e.replace(/-/g,"+").replace(/_/g,"/");const t=atob(e);return{earlyData:Uint8Array.from(t,(e=>e.charCodeAt(0))).buffer,error:null}}catch(e){return{earlyData:null,error:e}}}function u(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}const p=1,f=2;function h(e){try{e.readyState!==p&&e.readyState!==f||e.close()}catch(e){console.error("safeCloseWebSocket error",e)}}const m=[];for(let e=0;e<256;++e)m.push((e+256).toString(16).slice(1));function b(e,t=0){return(m[e[t+0]]+m[e[t+1]]+m[e[t+2]]+m[e[t+3]]+"-"+m[e[t+4]]+m[e[t+5]]+"-"+m[e[t+6]]+m[e[t+7]]+"-"+m[e[t+8]]+m[e[t+9]]+"-"+m[e[t+10]]+m[e[t+11]]+m[e[t+12]]+m[e[t+13]]+m[e[t+14]]+m[e[t+15]]).toLowerCase()}function w(e,t=0){const n=b(e,t);if(!u(n))throw TypeError("Stringified UUID is invalid");return n}async function g(e,t,n){let r=!1;const o=new TransformStream({start(e){},transform(e,t){for(let n=0;n<e.byteLength;){const r=e.slice(n,n+2),a=new DataView(r).getUint16(0),o=new Uint8Array(e.slice(n+2,n+2+a));n=n+2+a,t.enqueue(o)}},flush(e){}});o.readable.pipeTo(new WritableStream({async write(o){const s=await fetch(a,{method:"POST",headers:{"content-type":"application/dns-message"},body:o}),i=await s.arrayBuffer(),c=i.byteLength,l=new Uint8Array([c>>8&255,255&c]);e.readyState===p&&(n(`doh success and dns message length is ${c}`),r?e.send(await new Blob([l,i]).arrayBuffer()):(e.send(await new Blob([t,l,i]).arrayBuffer()),r=!0))}})).catch((e=>{n("dns udp has error"+e)}));const s=o.writable.getWriter();return{write(e){s.write(e)}}}const y="QA==",$="dmxlc3M=",k="RUR0dW5uZWw=";function v(e,t){const n=`:443?encryption=none&security=tls&sni=${t}&fp=randomized&type=ws&host=${t}&path=%2F%3Fed%3D2048#${t}`,a=e.split(","),o=a.map((e=>{const a=atob($)+"://"+e+atob(y)+t+n,o=atob($)+"://"+e+atob(y)+r+n;return`<h2>UUID: ${e}</h2>################################################################\nv2ray default ip\n---------------------------------------------------------------\n${a}\n<button onclick='copyToClipboard("${a}")'><i class="fa fa-clipboard"></i> Copy vlessMain</button>\n---------------------------------------------------------------\nv2ray with bestip\n---------------------------------------------------------------\n${o}\n<button onclick='copyToClipboard("${o}")'><i class="fa fa-clipboard"></i> Copy vlessSec</button>\n---------------------------------------------------------------`})).join("\n"),s=`https://${t}/sub/${a[0]}?format=clash`,i=`https://${t}/bestip/${a[0]}`,c=`https://api.v1.mk/sub?target=clash&url=${encodeURIComponent(s)}&insert=false&emoji=true&list=false&tfo=false&scv=true&fdn=false&sort=false&new_name=true`,l=`\n<p align='center'><img src='https://cloudflare-ipfs.com/ipfs/bafybeigd6i5aavwpr6wvnwuyayklq3omonggta4x2q7kpmgafj357nkcky' alt='图片描述' style='margin-bottom: -50px;'>\n<b style='font-size: 15px;'>Welcome! This function generates configuration for vless protocol. If you found this useful, please check our GitHub project for more:</b>\n<b style='font-size: 15px;'>欢迎！这是生成 vless 协议的配置。如果您发现这个项目很好用，请查看我们的 GitHub 项目给我一个star：</b>\n<a href='https://github.com/3Kmfi6HP/EDtunnel' target='_blank'>EDtunnel - https://github.com/3Kmfi6HP/EDtunnel</a>\n<iframe src='https://ghbtns.com/github-btn.html?user=USERNAME&repo=REPOSITORY&type=star&count=true&size=large' frameborder='0' scrolling='0' width='170' height='30' title='GitHub'></iframe>\n<a href='//${t}/sub/${a[0]}' target='_blank'>vless 节点订阅连接</a>\n<a href='clash://install-config?url=${encodeURIComponent(`https://${t}/sub/${a[0]}?format=clash`)}}' target='_blank'>Clash for Windows 节点订阅连接</a>\n<a href='${c}' target='_blank'>Clash 节点订阅连接</a>\n<a href='${i}' target='_blank'>优选IP自动节点订阅</a>\n<a href='clash://install-config?url=${encodeURIComponent(i)}' target='_blank'>Clash优选IP自动</a>\n<a href='sing-box://import-remote-profile?url=${encodeURIComponent(i)}' target='_blank'>singbox优选IP自动</a>\n<a href='sn://subscription?url=${encodeURIComponent(i)}' target='_blank'>nekobox优选IP自动</a>\n<a href='v2rayng://install-config?url=${encodeURIComponent(i)}' target='_blank'>v2rayNG优选IP自动</a></p>`;return`\n  <html>\n  \n  <head>\n\t<title>EDtunnel: vless configuration</title>\n\t<meta name='description' content='This is a tool for generating vless protocol configurations. Give us a star on GitHub https://github.com/3Kmfi6HP/EDtunnel if you found it useful!'>\n\t<meta name='keywords' content='EDtunnel, cloudflare pages, cloudflare worker, severless'>\n\t<meta name='viewport' content='width=device-width, initial-scale=1'>\n\t<meta property='og:site_name' content='EDtunnel: vless configuration' />\n\t<meta property='og:type' content='website' />\n\t<meta property='og:title' content='EDtunnel - vless configuration and subscribe output' />\n\t<meta property='og:description' content='Use cloudflare pages and worker severless to implement vless protocol' />\n\t<meta property='og:url' content='https://${t}/' />\n\t<meta property='og:image' content='https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=${encodeURIComponent(`vless://${e.split(",")[0]}@${t}${n}`)}' />\n\t<meta name='twitter:card' content='summary_large_image' />\n\t<meta name='twitter:title' content='EDtunnel - vless configuration and subscribe output' />\n\t<meta name='twitter:description' content='Use cloudflare pages and worker severless to implement vless protocol' />\n\t<meta name='twitter:url' content='https://${t}/' />\n\t<meta name='twitter:image' content='https://cloudflare-ipfs.com/ipfs/bafybeigd6i5aavwpr6wvnwuyayklq3omonggta4x2q7kpmgafj357nkcky' />\n\t<meta property='og:image:width' content='1500' />\n\t<meta property='og:image:height' content='1500' />\n\n\t<style>\n\tbody {\n\t  font-family: Arial, sans-serif;\n\t  background-color: #f0f0f0;\n\t  color: #333;\n\t  padding: 10px;\n\t}\n\n\ta {\n\t  color: #1a0dab;\n\t  text-decoration: none;\n\t}\n\timg {\n\t  max-width: 100%;\n\t  height: auto;\n\t}\n\n\tpre {\n\t  white-space: pre-wrap;\n\t  word-wrap: break-word;\n\t  background-color: #fff;\n\t  border: 1px solid #ddd;\n\t  padding: 15px;\n\t  margin: 10px 0;\n\t}\n\t/* Dark mode */\n\t@media (prefers-color-scheme: dark) {\n\t  body {\n\t\tbackground-color: #333;\n\t\tcolor: #f0f0f0;\n\t  }\n\n\t  a {\n\t\tcolor: #9db4ff;\n\t  }\n\n\t  pre {\n\t\tbackground-color: #282a36;\n\t\tborder-color: #6272a4;\n\t  }\n\t}\n\t</style>\n\n\t\x3c!-- Add FontAwesome library --\x3e\n\t<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css'>\n  </head>\n  \n  <body>\n  <pre style='background-color: transparent; border: none;'>${l}</pre>\n  <pre>${o}</pre>\n  </body>\n  <script>\n\tfunction copyToClipboard(text) {\n\t  navigator.clipboard.writeText(text)\n\t\t.then(() => {\n\t\t  alert("Copied to clipboard");\n\t\t})\n\t\t.catch((err) => {\n\t\t  console.error("Failed to copy to clipboard:", err);\n\t\t});\n\t}\n  <\/script>\n  </html>`}const S=new Set([80,8080,8880,2052,2086,2095,2082]),U=new Set([443,8443,2053,2096,2087,2083]);function x(e,t){const r=e.includes(",")?e.split(","):[e],a=`?encryption=none&security=none&fp=random&type=ws&host=${t}&path=%2F%3Fed%3D2048#`,o=`?encryption=none&security=tls&sni=${t}&fp=random&type=ws&host=${t}&path=%2F%3Fed%3D2048#`,s=r.flatMap((e=>{const r=Array.from(S).flatMap((r=>{if(!t.includes("pages.dev")){const o=`${t}-HTTP-${r}`,s=atob($)+"://"+e+atob(y)+t+":"+r+a+o;return n.flatMap((t=>{const n=atob($)+"://"+e+atob(y)+t+":"+r+a+o+"-"+t+"-"+atob(k);return[s,n]}))}return[]})),s=Array.from(U).flatMap((r=>{const a=`${t}-HTTPS-${r}`,s=atob($)+"://"+e+atob(y)+t+":"+r+o+a;return n.flatMap((t=>{const n=atob($)+"://"+e+atob(y)+t+":"+r+o+a+"-"+t+"-"+atob(k);return[s,n]}))}));return[...r,...s]}));return s.join("\n")}